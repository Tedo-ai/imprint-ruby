var Imprint=function(c){"use strict";class m{constructor(t){this.buffer=[],this.config=t,this.flushInterval=window.setInterval(()=>this.flush(),5e3),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&this.flush()}),window.addEventListener("beforeunload",()=>{this.flush()})}add(t){this.buffer.push(t),this.buffer.length>=50&&this.flush()}flush(){if(this.buffer.length===0)return;const t=[...this.buffer];this.buffer=[];const e=this.config.ingestUrl||"https://api.imprint.cloud/v1/spans";navigator.sendBeacon?(new Blob([JSON.stringify(t)],{type:"application/json"}),fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.publicKey}`},body:JSON.stringify(t),keepalive:!0}).catch(n=>console.error("Imprint flush failed",n))):fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.publicKey}`},body:JSON.stringify(t)}).catch(n=>console.error("Imprint flush failed",n))}}const h="imprint-browser",u="0.1.0",p="webjs";class g{constructor(t){this.activeSpan=null,this.config=t,this.transport=new m(t),this.traceId=this.getInitialTraceId()}getInitialTraceId(){const t=document.querySelector('meta[name="imprint-trace-id"]');return t?t.getAttribute("content")||this.generateId(32):this.generateId(32)}generateId(t){const e="0123456789abcdef";let n="";for(let r=0;r<t;r++)n+=e[Math.floor(Math.random()*e.length)];return n}startSpan(t,e,n="internal"){const r={trace_id:this.traceId,span_id:this.generateId(16),parent_id:e||(this.activeSpan?this.activeSpan.span_id:void 0),namespace:this.config.serviceName||window.location.hostname,name:t,kind:n,start_time:new Date().toISOString(),duration_ns:0,status_code:0};return new S(r,this.transport)}setActiveSpan(t){this.activeSpan=t}getActiveSpan(){return this.activeSpan}currentTraceHeader(){return this.activeSpan?`00-${this.traceId}-${this.activeSpan.span_id}-01`:""}event(t,e){var r;const n={trace_id:this.traceId,span_id:this.generateId(16),parent_id:(r=this.activeSpan)==null?void 0:r.span_id,namespace:this.config.serviceName||window.location.hostname,name:t,kind:"event",start_time:new Date().toISOString(),duration_ns:0,status_code:0};if(e&&Object.keys(e).length>0){n.attributes={};for(const[f,d]of Object.entries(e))n.attributes[f]=String(d)}else n.attributes={};n.attributes["telemetry.sdk.name"]=h,n.attributes["telemetry.sdk.version"]=u,n.attributes["telemetry.sdk.language"]=p,this.transport.add(n)}}class S{constructor(t,e){this.span=t,this.transport=e,this.startTime=performance.now()}end(){const t=performance.now()-this.startTime;this.span.duration_ns=Math.round(t*1e6),this.span.attributes||(this.span.attributes={}),this.span.attributes["telemetry.sdk.name"]=h,this.span.attributes["telemetry.sdk.version"]=u,this.span.attributes["telemetry.sdk.language"]=p,this.transport.add(this.span)}setStatus(t){this.span.status_code=t}setAttribute(t,e){this.span.attributes||(this.span.attributes={}),this.span.attributes[t]=String(e)}recordError(t){this.span.error_data=t instanceof Error?t.message+`
`+t.stack:String(t)}get id(){return this.span.span_id}get traceId(){return this.span.trace_id}get raw(){return this.span}}function w(s){const t=window.fetch;window.fetch=async function(e,n){const r=typeof e=="string"?e:e instanceof URL?e.toString():e.url,d=`FETCH ${(n==null?void 0:n.method)||"GET"} ${r}`,i=s.startSpan(d,void 0,"client"),o=s.currentTraceHeader();o&&(n||(n={}),n.headers||(n.headers={}),n.headers instanceof Headers?n.headers.set("traceparent",o):Array.isArray(n.headers)?n.headers.push(["traceparent",o]):n.headers.traceparent=o);try{const a=await t(e,n);return i.setStatus(a.status),i.end(),a}catch(a){throw i.recordError(a),i.end(),a}}}function b(s){let t=null;function e(){t&&t.end();const r=window.location.pathname;t=s.startSpan(`Page View ${r}`),s.setActiveSpan(t.raw)}e(),window.addEventListener("beforeunload",()=>{t&&(t.end(),t=null)}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&t&&(t.end(),t=null)});const n=history.pushState;history.pushState=function(...r){n.apply(this,r),e()},window.addEventListener("popstate",()=>{e()})}function v(s){window.addEventListener("error",t=>{const e=s.startSpan("CRASH");e.recordError(t.error||t.message),e.end()}),window.addEventListener("unhandledrejection",t=>{const e=s.startSpan("UNHANDLED_PROMISE");e.recordError(t.reason),e.end()})}function l(s){const t=new g(s);return b(t),w(t),v(t),t}return typeof window<"u"&&(window.Imprint={init:l}),c.init=l,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"}),c}({});
